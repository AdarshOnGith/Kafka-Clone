version: '3.8'

services:
  # Redis for rate limiting
  redis:
    image: redis:7-alpine
    container_name: dmq-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - dmq-network
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API Gateway
  api-gateway:
    build: .
    container_name: dmq-api-gateway
    environment:
      - SPRING_APPLICATION_NAME=dmq-api-gateway
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - DMQ_JWT_SECRET=${DMQ_JWT_SECRET:-dmq-secret-key-change-in-production-min-256-bits-long-for-hs256-algorithm}
      - DMQ_GATEWAY_AUTH_ENABLED=true
    ports:
      - "8080:8080"
    depends_on:
      - redis
    networks:
      - dmq-network
    volumes:
      - gateway-logs:/app/logs
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  redis-data:
    driver: local
  gateway-logs:
    driver: local

networks:
  dmq-network:
    driver: bridge
